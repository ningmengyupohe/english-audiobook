<!-- pages/search/search.wxml -->
<view class="search-container">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <view class="search-header">
    <view class="search-bar">
      <view class="search-back" bindtap="goBack">
        <text class="search-back-icon">â†</text>
      </view>
      <view class="search-input-container">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input" 
          placeholder="æœç´¢åˆ†ç±»ã€ä¹¦ç±ã€ä½œè€…..." 
          placeholder-class="search-placeholder"
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="onSearchConfirm"
          confirm-type="search"
          focus="{{true}}"
        />
        <text class="search-clear" wx:if="{{searchKeyword}}" bindtap="clearSearch">âœ•</text>
      </view>
      <view class="search-cancel" bindtap="goBack">
        å–æ¶ˆ
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ ‡ç­¾åŒºåŸŸ -->
  <view class="filter-tags-section" wx:if="{{showFilters}}">
    <!-- æ’åºæ–¹å¼ç­›é€‰ -->
    <view class="filter-group">
      <text class="filter-label">æ’åºæ–¹å¼ï¼š</text>
      <view class="filter-tags">
        <view 
          class="filter-tag {{activeSort === 'relevance' ? 'active' : ''}}" 
          data-sort="relevance"
          bindtap="switchSort"
        >
          <text class="tag-text">ç›¸å…³åº¦</text>
        </view>
        <view 
          class="filter-tag {{activeSort === 'hot' ? 'active' : ''}}" 
          data-sort="hot"
          bindtap="switchSort"
        >
          <text class="tag-text">æœ€çƒ­</text>
        </view>
        <view 
          class="filter-tag {{activeSort === 'latest' ? 'active' : ''}}" 
          data-sort="latest"
          bindtap="switchSort"
        >
          <text class="tag-text">æœ€æ–°</text>
        </view>
        <view 
          class="filter-tag {{activeSort === 'recommend' ? 'active' : ''}}" 
          data-sort="recommend"
          bindtap="switchSort"
        >
          <text class="tag-text">æ¨è</text>
        </view>
      </view>
    </view>
    
    <!-- éš¾åº¦çº§åˆ«ç­›é€‰ -->
    <view class="filter-group">
      <text class="filter-label">éš¾åº¦çº§åˆ«ï¼š</text>
      <view class="filter-tags">
        <view 
          class="filter-tag {{activeDifficulty === 'all' ? 'active' : ''}}" 
          data-difficulty="all"
          bindtap="switchDifficulty"
        >
          <text class="tag-text">å…¨éƒ¨</text>
        </view>
        <view 
          class="filter-tag {{activeDifficulty === 'åˆçº§' ? 'active' : ''}}" 
          data-difficulty="åˆçº§"
          bindtap="switchDifficulty"
        >
          <text class="tag-text">åˆçº§</text>
        </view>
        <view 
          class="filter-tag {{activeDifficulty === 'ä¸­çº§' ? 'active' : ''}}" 
          data-difficulty="ä¸­çº§"
          bindtap="switchDifficulty"
        >
          <text class="tag-text">ä¸­çº§</text>
        </view>
        <view 
          class="filter-tag {{activeDifficulty === 'é«˜çº§' ? 'active' : ''}}" 
          data-difficulty="é«˜çº§"
          bindtap="switchDifficulty"
        >
          <text class="tag-text">é«˜çº§</text>
        </view>
      </view>
    </view>
    
    <!-- åˆ†ç±»æ ‡ç­¾ç­›é€‰ -->
    <view class="filter-group" wx:if="{{categoryTags.length > 0}}">
      <text class="filter-label">åˆ†ç±»æ ‡ç­¾ï¼š</text>
      <view class="filter-tags">
        <view 
          wx:for="{{categoryTags}}" 
          wx:key="id"
          class="filter-tag {{activeCategories.indexOf(item.id) !== -1 ? 'active' : ''}}" 
          data-category="{{item.id}}"
          bindtap="toggleCategory"
        >
          <!-- ä¿®æ”¹ï¼šåªæ˜¾ç¤ºåˆ†ç±»åç§°ï¼Œç§»é™¤å›¾æ ‡å’Œæ•°é‡ -->
          <text class="tag-text">{{item.name}}</text>
        </view>
      </view>
    </view>
    
    <!-- æ¸…é™¤æ‰€æœ‰ç­›é€‰ -->
    <view class="clear-filters" wx:if="{{hasActiveFilters}}">
      <view class="clear-all-btn" bindtap="clearAllFilters">
        <text class="clear-icon">ğŸ—‘ï¸</text>
        <text class="clear-text">æ¸…é™¤æ‰€æœ‰ç­›é€‰</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢ç»“æœåŒºåŸŸ -->
  <view class="search-results" wx:if="{{showSearchResults}}">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{isLoading}}">
      <view class="loading-content">
        <view class="loading-spinner"></view>
        <text class="loading-text">æ­£åœ¨æœç´¢...</text>
      </view>
    </view>
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <view class="error-state" wx:if="{{loadError && !isLoading}}">
      <view class="error-content">
        <text class="error-icon">ğŸ˜”</text>
        <text class="error-title">{{errorMessage || 'æœç´¢å¤±è´¥'}}</text>
        <text class="error-desc">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</text>
        <button class="retry-button" bindtap="retrySearch">
          é‡æ–°æœç´¢
        </button>
      </view>
    </view>
    
    <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
    <view class="results-stats" wx:if="{{!isLoading && !loadError && filteredResults.length > 0}}">
      <text class="results-count">
        æ‰¾åˆ° <text class="count-number">{{filteredResults.length}}</text> ä¸ªç»“æœ
      </text>
    </view>
    
    <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
    <scroll-view 
      class="results-scroll" 
      scroll-y 
      bindscrolltolower="loadMore"
      enable-back-to-top="true"
      wx:if="{{!isLoading && !loadError}}"
    >
      <!-- æ— ç»“æœçŠ¶æ€ -->
      <view class="no-results" wx:if="{{filteredResults.length === 0 && searchKeyword}}">
        <view class="no-results-content">
          <text class="no-results-icon">ğŸ”</text>
          <text class="no-results-title">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</text>
          <text class="no-results-desc">
            æ²¡æœ‰æ‰¾åˆ°ä¸ "{{searchKeyword}}" ç›¸å…³çš„å†…å®¹
          </text>
          <button class="no-results-button" bindtap="clearSearch">
            é‡æ–°æœç´¢
          </button>
        </view>
      </view>
      
      <!-- ä¹¦ç±ç»“æœ -->
      <view class="books-list" wx:if="{{filteredResults.length > 0}}">
        <view class="book-card" 
              wx:for="{{filteredResults}}" 
              wx:key="_id"
              data-id="{{item._id}}"
              bindtap="goToBook">
          <view class="book-cover-container">
            <image 
              src="{{item.cover || '/images/covers/default.jpg'}}" 
              class="book-cover"
              mode="aspectFill"
            />
            <view class="book-badge" wx:if="{{item.recommendBadge}}">
              <text class="badge-text">{{item.recommendBadge === 'hot' ? 'çƒ­é—¨' : 'æ¨è'}}</text>
            </view>
          </view>
          <view class="book-info">
            <text class="book-title">{{item.title}}</text>
            <text class="book-author">{{item.author || 'æœªçŸ¥ä½œè€…'}}</text>
            <view class="book-meta">
              <view class="book-meta-item">
                <text class="meta-icon">ğŸ“–</text>
                <text class="meta-text">{{item.totalChapters || 0}}ç« </text>
              </view>
              <view class="book-meta-item">
                <text class="meta-icon">â¤ï¸</text>
                <text class="meta-text">{{item.likeCount || 0}}</text>
              </view>
              <view class="book-meta-item">
                <view class="level-badge {{getDifficultyClass(item.level)}}">
                  {{item.level || 'ä¸­çº§'}}
                </view>
              </view>
            </view>
            <text class="book-desc" wx:if="{{item.description}}">
              {{item.description}}
            </text>
            <view class="book-tags">
              <view class="book-tag" style="border-color: {{getCategoryColor(item.categoryId)}}; color: {{getCategoryColor(item.categoryId)}}">
                {{item.categoryName || 'æœªåˆ†ç±»'}}
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view class="load-more" wx:if="{{hasMore && filteredResults.length > 0}}">
        <text class="load-text" wx:if="{{!isLoading}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š...</text>
        <view class="loading-more" wx:if="{{isLoading}}">
          <view class="loading-dots">
            <text class="dot"></text>
            <text class="dot"></text>
            <text class="dot"></text>
          </view>
          <text class="loading-text">åŠ è½½ä¸­</text>
        </view>
      </view>
      
      <!-- æ— æ›´å¤šæ•°æ® -->
      <view class="no-more" wx:if="{{!hasMore && filteredResults.length > 0}}">
        <text class="no-more-text">æ²¡æœ‰æ›´å¤šå†…å®¹äº†</text>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢åˆå§‹çŠ¶æ€ï¼ˆæ— å…³é”®è¯æ—¶ï¼‰ -->
  <view class="search-init" wx:if="{{!searchKeyword && !isLoading && !loadError && searchResults.length === 0}}">
    <view class="init-content" style="height: 1327rpx; display: flex; box-sizing: border-box">
      <text class="init-icon">ğŸ”</text>
      <text class="init-title">æœç´¢ä½ æƒ³æ‰¾çš„å†…å®¹</text>
      <text class="init-desc">è¾“å…¥å…³é”®è¯æœç´¢åˆ†ç±»ã€ä¹¦ç±æˆ–ä½œè€…</text>
      
      <!-- çƒ­é—¨æœç´¢æ ‡ç­¾ -->
      <view class="hot-tags">
        <view class="hot-tag" 
              wx:for="{{hotKeywords}}" 
              wx:key="index" 
              data-keyword="{{item.keyword}}" 
              bindtap="onHotKeywordTap"
              style="background: {{item.color}}">
          <text class="hot-tag-icon">{{item.icon}}</text>
          <text class="hot-tag-text">{{item.keyword}}</text>
          <text class="hot-tag-type">{{item.type}}</text>
        </view>
      </view>
      
      <!-- æœ€è¿‘æœç´¢ -->
      <view class="recent-search" wx:if="{{searchHistory.length > 0}}">
        <view class="recent-header">
          <text class="recent-title">æœ€è¿‘æœç´¢</text>
          <text class="recent-clear" bindtap="clearSearchHistory">æ¸…ç©º</text>
        </view>
        <view class="recent-list">
          <view class="recent-item" 
                wx:for="{{searchHistory}}" 
                wx:key="index" 
                data-keyword="{{item}}"
                bindtap="onHistoryTap">
            <text class="recent-icon">ğŸ•</text>
            <text class="recent-text">{{item}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>